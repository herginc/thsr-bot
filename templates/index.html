<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>高鐵訂票系統</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        /* (CSS 樣式保持不變) */
        body { font-family: "Noto Sans TC", Arial, sans-serif; background: #f7f7fa; margin: 0; padding: 0; }
        header { background: #1565c0; color: #fff; padding: 1.5rem 0; text-align: center; letter-spacing: 0.1em; font-size: 2rem; margin-bottom: 2rem; box-shadow: 0 2px 8px #ccc; }
        .container { max-width: 900px; margin: 0 auto; background: #fff; border-radius: 10px; box-shadow: 0 2px 12px #ddd; padding: 2rem 2.5rem 2.5rem 2.5rem; }
        h2, h3 { color: #1565c0; margin-top: 0; }
        form { display: flex; flex-wrap: wrap; gap: 1.2rem 2rem; margin-bottom: 2rem; align-items: flex-end; }
        form label { display: flex; flex-direction: column; font-weight: bold; color: #333; font-size: 1rem; flex: 1 1 180px; min-width: 120px; }
        form input, form select { padding: 0.5rem; border: 1px solid #bbb; border-radius: 6px; margin-top: 0.3rem; }
        form button { background: #4caf50; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer; font-weight: bold; transition: background 0.3s; }
        form button:hover { background: #388e3c; }
        .alert { background: #fff3cd; color: #856404; padding: 1rem; border: 1px solid #ffeeba; border-radius: 6px; margin-bottom: 1.5rem; }
        table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; background: #fafbfc; font-size: 0.9rem; }
        th, td { border: 1px solid #eee; padding: 0.75rem; text-align: left; }
        th { background: #e0eaff; color: #1565c0; font-weight: bold; }
        tr:nth-child(even) { background: #f2f6ff; }
        .status-running, .status-cancelling { color: #ff9800; font-weight: bold; }
        .status-pending { color: #607d8b; }
        .status-success { color: #4caf50; font-weight: bold; }
        .status-failed, .status-cancelled { color: #f44336; }
        .delete-button { background: #f44336; color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        .delete-button:hover { background: #d32f2f; }

        @media (max-width: 768px) {
            .container { padding: 1rem; }
            form { flex-direction: column; gap: 1rem; align-items: stretch; }
            form label { flex: none; }
            header { padding: 1rem 0; }
            h2 { font-size: 1.1rem; }
            table, th, td { font-size: 0.75rem; }
        }
    </style>
</head>
<body>
    <header>高鐵訂票系統</header>
    <div class="container">
        <a href="/passenger.html">管理乘客個人資料 &#x2192;</a>
        <a href="/history.html">歷史訂票資訊 &#x2192;</a>
        
        <h2>新增訂票任務</h2>
        
        <form id="booking-form">
            <label>
                出發站
                <select name="start_station" required>
                    <option value="">請選擇</option>
                    <option value="南港">南港</option>
                    <option value="台北">台北</option>
                    <option value="板橋">板橋</option>
                    <option value="桃園">桃園</option>
                    <option value="新竹">新竹</option>
                    <option value="苗栗">苗栗</option>
                    <option value="台中">台中</option>
                    <option value="彰化">彰化</option>
                    <option value="雲林">雲林</option>
                    <option value="嘉義">嘉義</option>
                    <option value="台南">台南</option>
                    <option value="左營">左營</option>
                </select>
            </label>
            <label>
                到達站
                <select name="end_station" required>
                    <option value="">請選擇</option>
                    <option value="南港">南港</option>
                    <option value="台北">台北</option>
                    <option value="板橋">板橋</option>
                    <option value="桃園">桃園</option>
                    <option value="新竹">新竹</option>
                    <option value="苗栗">苗栗</option>
                    <option value="台中">台中</option>
                    <option value="彰化">彰化</option>
                    <option value="雲林">雲林</option>
                    <option value="嘉義">嘉義</option>
                    <option value="台南">台南</option>
                    <option value="左營">左營</option>
                </select>
            </label>
            <label>
                乘車日期
                <input type="date" name="travel_date" required>
            </label>
            <label>
                乘車時間
                <input type="time" name="train_time" value="08:00" required>
            </label>
            <label>
                車次 (選填)
                <input name="train_no" placeholder="例如: 111">
            </label>
            <label>
                乘客姓名
                <select name="name" id="passenger-select" required>
                    <option value="">請選擇乘客</option>
                    </select>
            </label>
            <label>
                張數
                <input type="number" name="ticket_count" value="1" min="1" max="10" required>
            </label>
            <button type="submit">提交任務</button>
        </form>

        <h2>訂票任務狀態</h2>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>姓名</th>
                        <th>訂票資訊 (新格式)</th>
                        <th>狀態</th>
                        <th>訊息</th>
                        <th>提交時間</th>
                        <th>更新時間</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="status-table-body">
                    <tr>
                        <td colspan="8">載入中...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <p style="margin-top: 1rem; font-size: 0.85rem; color: #666;">
            已完成任務會在成功 2 天後、失敗/取消 60 分鐘後自動從此列表移除並歸檔到歷史紀錄。
        </p>
    </div>

    <script>
        const API_STATUS_URL = '/api/status';
        const API_SUBMIT_URL = '/api/submit';
        const API_CANCEL_URL = '/api/cancel';
        const API_PASSENGER_URL = '/api/passenger';
        const statusTableBody = document.getElementById('status-table-body');
        const passengerSelect = document.getElementById('passenger-select');

        // 【新增/修改】追蹤變數和計時器 ID
        let hasActiveTasks = false;
        let statusIntervalId = null;

        // 載入乘客資料
        function loadPassengers() {
            fetch(API_PASSENGER_URL)
                .then(response => response.json())
                .then(passengers => {
                    passengerSelect.innerHTML = '<option value="">請選擇乘客</option>';
                    if (passengers.length === 0) {
                        passengerSelect.innerHTML = '<option value="">請先新增乘客個人資料</option>';
                    } else {
                        passengers.forEach(p => {
                            const option = document.createElement('option');
                            option.value = p.id;            // ✅ 修正 1：使用 p.id 作為 value
                            option.textContent = p.name;    // ✅ 修正 2：只顯示姓名，不再顯示 personal_id 的部分資訊
                            option.dataset.name = p.name; 
                            passengerSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('Fetching passengers failed:', error);
                });
        }

        // 提交表單處理 (提交成功後會呼叫 fetchAndUpdateStatus)
        document.getElementById('booking-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => data[key] = value);

            // 獲取選擇的乘客姓名和 ID
            const selectedOption = passengerSelect.options[passengerSelect.selectedIndex];
            if (selectedOption && selectedOption.value) {
                // ✅ 修正 3：使用一個新的 key (passenger_internal_id) 來傳輸非敏感的內部 ID
                data.passenger_internal_id = selectedOption.value; 
                data.name = selectedOption.dataset.name;
            } else {
                alert("請選擇有效的乘客或新增乘客資料。");
                return;
            }

            // *** 檢查：確保沒有選到預設的請先新增乘客個人資料 ***
            const name_select = form.querySelector('select[name="name"]');
            if (name_select && name_select.value === "") {
                const selected_option = name_select.options[name_select.selectedIndex];
                if (selected_option.text === "請先新增乘客個人資料") {
                    alert("請先前往 '乘客個人資料' 頁面新增乘客資料。");
                    return; 
                }
            }
            // *** 檢查結束 ***

            fetch(API_SUBMIT_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json', 
                },
                // body 提交的 JSON 中，data 僅含 name
                body: JSON.stringify(data) 
            })
            .then(response => response.json())
            .then(result => {
                if (result.status === 'success') {
                    // alert(`訂票任務已成功提交！任務 ID: ${result.task_id}`);
                    // form.reset(); // 不重置，保留使用者選取的站點等資訊
                    // 僅重置下拉選單到預設狀態
                    const name_select = form.querySelector('select[name="name"]');
                    if (name_select) {
                        name_select.selectedIndex = 0; 
                    }
                    
                    fetchAndUpdateStatus(); 
                } else {
                    alert('提交失敗: ' + result.message);
                }            })
            .catch(error => {
                console.error('提交錯誤:', error);
                alert('提交任務時發生錯誤，請檢查主控台。');
            });
        });

        // 取消/刪除任務
        function cancelBooking(taskId) {
            if (!confirm(`確定要取消/刪除任務 ${taskId} 嗎？`)) {
                return;
            }
            fetch(`${API_CANCEL_URL}/${taskId}`, { method: 'POST' })
                .then(response => response.json())
                .then(result => {
                    alert(result.message);
                    fetchAndUpdateStatus();
                })
                .catch(error => {
                    console.error('取消/刪除錯誤:', error);
                });
        }

        // --- 取得並更新任務狀態 ---
        function fetchAndUpdateStatus_old2() {
            // 假設 API_STATUS_URL 和 statusTableBody 已經定義
            fetch(API_STATUS_URL)
                .then(response => response.json())
                .then(data => {
                    const tasks = data.tasks; 
                    statusTableBody.innerHTML = '';

                    // 1. 健壯性檢查：確保 tasks 是個陣列
                    if (!Array.isArray(tasks)) {
                        const errorMessage = data.message || `API 返回資料格式錯誤: ${JSON.stringify(data)}`;
                        console.error('API Error:', errorMessage, data);
                        // 假設您的表格有 9 欄 (8 個資料欄位 + 1 個操作欄位)
                        statusTableBody.innerHTML = `<tr><td colspan="9" style="color: #dc3545; font-weight: bold;">無法載入狀態資訊: ${errorMessage}</td></tr>`;
                        return;
                    }
                    
                    if (tasks.length === 0) {
                        statusTableBody.innerHTML = '<tr><td colspan="9">目前沒有進行中的訂票任務。</td></tr>';
                        return;
                    }

                    tasks.forEach(task => {
                        // 2. 解析 train_info 欄位
                        // 格式: 從 [Start] 到 [End] ([Date] [Time])
                        const match = task.train_info.match(/從\s*([^到]+)\s*到\s*([^ (]+)\s*\(([^ ]+)\s*([^)]+)\)/);
                        let start_station = 'N/A';
                        let end_station = 'N/A';
                        let travel_date = 'N/A';
                        let train_time = 'N/A';
                        
                        if (match) {
                            start_station = match[1].trim();
                            end_station = match[2].trim();
                            travel_date = match[3].trim();
                            train_time = match[4].trim();
                        }

                        const row = statusTableBody.insertRow();
                        
                        // 狀態 class 名稱 (用於 CSS 樣式)
                        const statusClass = `status-${task.status}`; 
                        
                        // 狀態中文標籤
                        let statusLabel = task.status;
                        if (task.status === 'pending') statusLabel = '等待中';
                        else if (task.status === 'running') statusLabel = '訂票中';
                        else if (task.status === 'success') statusLabel = '✅ 成功';
                        else if (task.status === 'failed') statusLabel = '❌ 失敗';
                        else if (task.status === 'cancelling') statusLabel = '取消中';

                        // 1. ID (使用 task.id)
                        row.insertCell().textContent = task.id; 

                        // 2. 姓名 (使用 task.passenger_name)
                        row.insertCell().textContent = task.passenger_name; 

                        // 3. 訂票結果/進度
                        row.insertCell().textContent = task.message || '等待中...';
                        
                        // 4. 狀態
                        const statusCell = row.insertCell();
                        statusCell.innerHTML = `<span class="${statusClass}">${statusLabel}</span>`;
                        
                        // 5. 起訖站點 
                        row.insertCell().textContent = `${start_station} → ${end_station}, ${travel_date} ${train_time}`;
                        
                        // // 6. 乘車日期
                        // row.insertCell().textContent = travel_date;
                        
                        // // 7. 最早時間
                        // row.insertCell().textContent = train_time;
                        
                        // 6. 更新時間 (僅顯示時間部分)
                        row.insertCell().textContent = task.update_time ? task.update_time.split(' ')[1] : '—';
                        
                        // 7. 操作
                        const deleteCell = row.insertCell();
                        
                        if (task.status === 'pending' || task.status === 'running' || task.status === 'cancelling') {
                            const deleteButton = document.createElement('button');
                            deleteButton.textContent = (task.status === 'running' || task.status === 'cancelling') ? '放棄' : '刪除';
                            deleteButton.className = 'delete-button';
                            // 確保呼叫函式時使用正確的 ID 欄位
                            deleteButton.onclick = () => cancelBooking(task.id); 
                            deleteCell.appendChild(deleteButton);
                        } else {
                            deleteCell.textContent = '—';
                        }
                    });
                })
                .catch(error => {
                    console.error('Fetching status failed:', error);
                    statusTableBody.innerHTML = '<tr><td colspan="9" style="color: #dc3545; font-weight: bold;">無法載入狀態資訊：網路或伺服器連線錯誤。</td></tr>';
                });
        }

        function fetchAndUpdateStatus() {
            // 假設 API_STATUS_URL 和 statusTableBody 已經定義
            fetch(API_STATUS_URL)
                .then(response => response.json())
                .then(data => {
                    const tasks = data.tasks; 
                    statusTableBody.innerHTML = '';
                    
                    // 【修改點 1】重置 activeTasks 旗標
                    let newActiveTasks = false; 

                    // 1. 健壯性檢查：確保 tasks 是個陣列
                    if (!Array.isArray(tasks)) {
                        const errorMessage = data.message || `API 返回資料格式錯誤: ${JSON.stringify(data)}`;
                        console.error('API Error:', errorMessage, data);
                        // 假設您的表格有 9 欄 (8 個資料欄位 + 1 個操作欄位)
                        statusTableBody.innerHTML = `<tr><td colspan="9" style="color: #dc3545; font-weight: bold;">無法載入狀態資訊: ${errorMessage}</td></tr>`;
                        // 即使錯誤，我們也假設沒有活躍任務
                        updateInterval(false); 
                        return;
                    }
                    
                    if (tasks.length === 0) {
                        statusTableBody.innerHTML = '<tr><td colspan="9">目前沒有進行中的訂票任務。</td></tr>';
                        // 【修改點 2】沒有任務時停止更新
                        updateInterval(false); 
                        return;
                    }

                    tasks.forEach(task => {
                        // 【修改點 3】檢查是否有 pending 或 running 任務
                        if (task.status === 'pending' || task.status === 'running') {
                            newActiveTasks = true;
                        }

                        // 2. 解析 train_info 欄位
                        // 格式: 從 [Start] 到 [End] ([Date] [Time])
                        const match = task.train_info.match(/從\s*([^到]+)\s*到\s*([^ (]+)\s*\(([^ ]+)\s*([^)]+)\)/);
                        let start_station = 'N/A';
                        let end_station = 'N/A';
                        let travel_date = 'N/A';
                        let train_time = 'N/A';
                        
                        if (match) {
                            start_station = match[1].trim();
                            end_station = match[2].trim();
                            travel_date = match[3].trim();
                            train_time = match[4].trim();
                        }

                        const row = statusTableBody.insertRow();
                        
                        // 狀態 class 名稱 (用於 CSS 樣式)
                        const statusClass = `status-${task.status}`; 
                        
                        // 狀態中文標籤
                        let statusLabel = task.status;
                        if (task.status === 'pending') statusLabel = '等待中';
                        else if (task.status === 'running') statusLabel = '訂票中';
                        else if (task.status === 'success') statusLabel = '✅ 成功';
                        else if (task.status === 'failed') statusLabel = '❌ 失敗';
                        else if (task.status === 'cancelling') statusLabel = '取消中';

                        // 1. ID (使用 task.id)
                        row.insertCell().textContent = task.id; 

                        // 2. 姓名 (使用 task.passenger_name)
                        row.insertCell().textContent = task.passenger_name; 

                        // 3. 訂票資訊 (新格式)
                        // 這是表格中的 '訂票資訊 (新格式)' 欄位。原始程式碼使用了 task.message，但標題是『訂票資訊 (新格式)』，
                        // 且下方將 message 換成了 起訖站點。我們依照您提供的程式碼邏輯（但將欄位標題與內容對應）
                        // 這裡應該是 train_info 的簡潔版或其他描述。
                        // 根據程式碼邏輯，第 3 欄位原本是 `task.message`，現在新格式似乎是指將其與 station 資訊結合。
                        // 為了與您原來的程式碼結構保持一致，我將 task.message 放在第 4 欄，而將起訖站點資訊放在第 3 欄。
                        // 但是表格標題是：ID, 姓名, 訂票資訊 (新格式), 狀態, 訊息, 提交時間, 更新時間, 操作 (共 8 欄)
                        // 而您的 JS 程式碼插入了 7 個儲存格（不含操作），且順序是：
                        // ID, 姓名, 訂票結果/進度 (task.message), 狀態, 起訖站點 (新格式), 更新時間
                        
                        // **我們將欄位與您提供的 HTML 保持一致：**
                        // ID -> task.id (OK)
                        // 姓名 -> task.passenger_name (OK)
                        // 訂票資訊 (新格式) -> ${start_station} → ${end_station}, ${travel_date} ${train_time}
                        // 狀態 -> statusLabel (OK)
                        // 訊息 -> task.message (OK)
                        // 提交時間 -> N/A (此欄位在 JS 裡被移除了，所以我們將其補回，但因為 API 沒給 submit_time，所以用 N/A)
                        // 更新時間 -> task.update_time (OK)
                        // 操作 -> Button (OK)


                        // 3. 訂票資訊 (新格式) - 站點與時間
                        row.insertCell().textContent = `${start_station} → ${end_station} (${travel_date} ${train_time})`;
                        
                        // 4. 狀態
                        const statusCell = row.insertCell();
                        statusCell.innerHTML = `<span class="${statusClass}">${statusLabel}</span>`;

                        // 5. 訊息 (使用 task.message)
                        row.insertCell().textContent = task.message || '等待中...';
                        
                        // 6. 提交時間 (API 未提供，假設從 train_info 解析)
                        // 由於 API 提供的資料 task 裡沒有 submit_time，這裡暫時使用 —
                        // row.insertCell().textContent = task.submit_time ? task.submit_time.split(' ')[1] : '—'; 
                        row.insertCell().textContent = 'TBD'; // 假設後端沒有提供

                        // 7. 更新時間 (僅顯示時間部分)
                        row.insertCell().textContent = task.update_time ? task.update_time.split(' ')[1] : '—';
                        
                        // 8. 操作
                        const deleteCell = row.insertCell();
                        
                        if (task.status === 'pending' || task.status === 'running' || task.status === 'cancelling') {
                            const deleteButton = document.createElement('button');
                            deleteButton.textContent = (task.status === 'running' || task.status === 'cancelling') ? '放棄' : '刪除';
                            deleteButton.className = 'delete-button';
                            // 確保呼叫函式時使用正確的 ID 欄位
                            deleteButton.onclick = () => cancelBooking(task.id); 
                            deleteCell.appendChild(deleteButton);
                        } else {
                            deleteCell.textContent = '—';
                        }
                    });
                    
                    // 【修改點 4】在任務列表渲染完成後，根據新的活躍任務狀態更新計時器
                    updateInterval(newActiveTasks);

                })
                .catch(error => {
                    console.error('Fetching status failed:', error);
                    statusTableBody.innerHTML = '<tr><td colspan="9" style="color: #dc3545; font-weight: bold;">無法載入狀態資訊：網路或伺服器連線錯誤。</td></tr>';
                    // 【修改點 5】如果失敗，停止更新，直到使用者再次操作
                    updateInterval(false); 
                });
        }

        // 【新增函式】控制自動更新的計時器
        function updateInterval(shouldBeActive) {
            // 檢查是否需要啟動/維持計時器
            if (shouldBeActive) {
                // 如果目前沒有計時器，則啟動一個
                if (statusIntervalId === null) {
                    console.log("啟動狀態自動更新 (5 秒)");
                    statusIntervalId = setInterval(fetchAndUpdateStatus, 5000);
                    hasActiveTasks = true;
                }
            } else {
                // 如果目前有計時器，但不需要了，則清除它
                if (statusIntervalId !== null) {
                    console.log("停止狀態自動更新");
                    clearInterval(statusIntervalId);
                    statusIntervalId = null;
                    hasActiveTasks = false;
                }
            }
        }
        
        // 首次載入和每 5 秒自動更新
        document.addEventListener('DOMContentLoaded', () => {
            loadPassengers(); // 確保乘客資料先載入
            fetchAndUpdateStatus();
        });

        // 移除原有的 setInterval(fetchAndUpdateStatus, 5000);
        // 現在由 updateInterval(true/false) 邏輯來控制計時器的啟動與停止。
    </script>
</body>
</html>